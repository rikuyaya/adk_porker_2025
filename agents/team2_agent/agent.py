from google.adk.agents import Agent,SequentialAgent

# 各ツールのインポート
# from .game_state_parser_agent.tool import GameStateParser
from .victory_calculation_agent.tool import EquityCalculator
from .pot_odds_calculator_agent.tool import PokerMetricsCalculator
from .victory_calculation_agent.position_tool import PositionCalculator
# from .bet_sizing_tool_agent.tool import SizingTool

from google.adk.models.lite_llm import LiteLlm

# エージェントの名前定義
AGENT_NAME = "team2_agent"
MODEL_GPT_4O = "openai/gpt-4o-mini"

victory_calculation_agent = Agent(
    name="victory_calculation_agent",
    # model="gemini-2.5-flash-lite",
    model=LiteLlm(model=MODEL_GPT_4O),
    description="勝率計算エージェント",
    instruction="""
    あなたは、複数の分析エージェントからの情報を統合し、最終的なポーカーアクションを決定する専門家です。現在のゲームフェーズに応じた戦略に基づき、常に論理的かつ利益が最大化されるアクションを選択してください。

    【考慮すべき情報】
    1.  **ゲーム状態**:
        -   **現在のハンド数**
        -   **現在のチップ順位**
        -   ホールカード、コミュニティカード、自分のポジション、対戦相手の数とスタックサイズ、ポットサイズ、コールに必要な金額、利用可能なアクション。
    2.  **ハンド評価**:
        -   ハンドエクティ（勝率）、ハンドの強さとカテゴリ（プレミアム、ストロング、マージナル、ウィークなど）、アウツ（役が完成するカードの枚数）。
    3.  **オッズと期待値**:
        -   ポットオッズと、それに伴うコールの利益性。アクションの期待値（EV）。
    4.  **ゲームの動向**:
        -   これまでのハンド履歴（history）から推測される相手のプレイスタイル（例：アグレッシブか、パッシブか）。

    ---

    【ゲームフェーズに応じた戦略変更】
    ゲームの進行状況に応じて、以下の戦略を厳密に使い分けてください。

    **1. 序盤戦 (ハンド1〜10): 堅実・基礎戦略**
    - **目的**: チップを維持し、大きなリスクを避ける。
    - **判断基準**: **ハンドエクイティ（勝率）と期待値（EV）を最重要視**します。
    - **アクション**:
        - プリフロップでは、勝率の高いハンド（プレミアム、ストロングカテゴリ）でのみ参加します。マージナルなハンドや弱いハンドは積極的にフォールドしてください。
        - ブラフは最小限に留め、自分のハンドの強さに正直なプレイを心がけてください。
        - 強い役が完成した場合（バリューベット）にのみ、積極的にベット/レイズを行います。

    **2. 中盤戦 (ハンド11〜20): 積極・攻撃戦略**
    - **目的**: 積極的にポットを狙い、チップを増やす。
    - **判断基準**: ハンドの強さに加え、**ポジションの有利さや相手の弱み**を突くことを重視します。
    - **アクション**:
        - 参加するハンドの範囲を少し広げます。
        - **ブラフやセミブラフを積極的に活用**します。特に有利なポジションにいる場合や、相手が消極的と判断できる場合は、強いベットでプレッシャーをかけてください。
        - 相手がチェックで回してきた際には、積極的にベットしてポットを獲得すること（フロートベット）も検討します。

    **3. 終盤戦 (ハンド21以降): 状況適応戦略**
    - **もし自分が1位（チップリーダー）の場合: 防衛戦略**
        - **目的**: リードを維持し、リスクを最小化する。
        - **アクション**: 再び堅実なプレイに戻ります。**非常に強いハンド（プレミアムハンドやナッツ級の役）を持っている場合にのみ**、大きなベットを行います。不必要な勝負は避け、チップを失うリスクを最小限に抑えてください。
    - **もし自分が1位でない場合: 逆転戦略**
        - **目的**: 1位を目指し、計算されたリスクを取る。
        - **アクション**: 中盤戦の積極的な戦略を継続しつつ、相手のスタックサイズを考慮に入れます。特に自分よりチップの少ない相手には積極的にプレッシャーをかけ、チップを奪うことを狙います。

    ---

    【決定プロセス】
    1.  まず、現在のハンド数とチップ順位を確認し、【ゲームフェーズに応じた戦略変更】で定められた戦略（序盤戦、中盤戦、終盤戦）を決定します。
    2.  現在のフェーズ戦略に基づき、ハンド評価、オッズ、相手の動向を総合的に評価します。
    3.  現在の戦略の目的に沿って、最も期待値が高いと判断されるアクション（コール、レイズ、フォールドなど）を最終決定します。

    【出力形式】
    必ず次のJSON形式で回答してください。他のテキストは含めないでください。
    {
    "action": "fold|check|call|raise|all_in",
    "amount": <数値（ベット/レイズの場合のみ、それ以外は0）>,
    "reasoning": "現在のゲームフェーズ（序盤/中盤/終盤）、適用戦略、そして各分析結果を踏まえ、なぜそのアクションと金額が最適だと判断したのかを詳細に説明してください。"
    }

    【重要な注意事項】
    -   利用可能なアクションの範囲内でのみ決定してください。
    -   ベット/レイズの場合は、自分や相手のスタックサイズを超えない現実的な金額を指定してください。
    -   分析結果が矛盾する場合や情報が不完全な場合は、リスクを最小限に抑える最も安全な選択（チェックが可能ならチェック、無理ならフォールド）を検討してください。
    """,
    tools=[PositionCalculator,EquityCalculator,PokerMetricsCalculator],
)

output_agent = Agent(
    name="output_agent",
    model=LiteLlm(model=MODEL_GPT_4O),
    # model="gemini-2.5-flash-lite",
    description="最終的なアクション決定エージェント",
    instruction="""
    あなたは最終的なポーカーアクション決定の専門エージェントです。

    前の全てのエージェントから受け取った分析結果を総合的に評価し、最適なアクションを決定してください：

    【考慮すべき情報】
    1. ゲーム状態解析結果：
       - ホールカード、コミュニティカード
       - ポットサイズ、コール金額
       - ポジション、対戦相手数
       - 利用可能なアクション

    2. 勝率計算結果：
       - ハンドエクイティ
       - ハンド強度とカテゴリ
       - 改善可能性（アウツ）
       - GTO分析結果（プリフロップの場合）

    3. ポットオッズ分析結果：
       - コールの利益性
       - 期待値
       - 推奨アクション（strong_call/call/fold等）

    4. ベットサイズ計算結果（ベット/レイズの場合）：
       - 推奨ベットサイズ
       - 戦略的目標

    【決定プロセス】
    1. 利用可能なアクションを確認
    2. 各分析結果の整合性をチェック
    3. 最も論理的で利益的なアクションを選択
    4. ベット/レイズの場合は適切な金額を決定

    【出力形式】
    必ず次のJSON形式で回答してください：
    {
      "action": "fold|check|call|raise|all_in",
      "amount": <数値（ベット/レイズの場合のみ、それ以外は0）>,
      "reasoning": "各エージェントの分析結果を踏まえた決定理由を詳細に説明"
    }

    【重要な注意事項】
    - 利用可能なアクションの範囲内で決定してください
    - ベット/レイズの場合は、スタックサイズを超えない金額を指定してください
    - 分析結果が矛盾する場合は、より信頼性の高い情報を優先してください
    - 必ずJSON形式で回答し、他の形式は使用しないでください
    """,
)


root_agent = SequentialAgent(
    name=AGENT_NAME,
    sub_agents=[
        victory_calculation_agent,
        output_agent,
    ],
)

# instruction="""
#     あなたは、複数の分析エージェントからの情報を統合し、最終的なポーカーアクションを決定する専門家です。常に論理的かつ利益が最大化されるアクションを選択してください。特に、不必要なフォールドを避け、有利な状況では積極的にポットの獲得を目指します。
#     【考慮すべき情報】
#     1.  **ゲーム状態**:
#         -   ホールカード、コミュニティカード、自分のポジション、対戦相手の数とスタックサイズ、ポットサイズ、コールに必要な金額、利用可能なアクション。
#     2.  **ハンド評価**:
#         -   ハンドエクイティ（勝率）、ハンドの強さとカテゴリ（プレミアム、ストロング、マージナル、ウィークなど）、アウツ（役が完成するカードの枚数）。
#     3.  **オッズと期待値**:
#         -   ポットオッズと、それに伴うコールの利益性。アクションの期待値（EV）。
#     4.  **ゲームの動向**:
#         -   これまでのハンド履歴（history）から推測される相手のプレイスタイル（例：アグレッシブか、パッシブか）。

#     【戦略的指針】
#     1.  **主導権の掌握**: 強いハンドやドロー（あと1枚で役が完成する状態）を持つ場合、ただコールするだけでなく、レイズによって積極的にポットの主導権を握ることを検討してください。これにより相手にプレッシャーを与え、情報を引き出すことができます。
#     2.  **バリューベット**: 自分が勝っている可能性が高いと判断した場合、相手がコールしてくれそうな適切なサイズのベットやレイズを行い、ポットの価値を最大化してください。チェックで回して相手にフリーカードを与えないように注意してください。
#     3.  **ブラフとセミブラフ**: 有利なポジション（例：ディーラーボタン）にいる場合や、相手が消極的であると判断できる場合、ポットを獲得するためのブラフや、強いドローを持つ場合のセミブラフも有効な選択肢です。
#     4.  **ポットコミットメントの意識**: 自分のスタックサイズとポットサイズを比較し、このハンドにどれだけ投資すべきかを常に意識してください。特に、大きなベットに直面した際は、残りスタックでオールインする覚悟があるかどうかが判断基準になります。

#     【決定プロセス】
#     1.  まず、ハンド評価とゲーム状態から、自分のハンドが現在どの程度の強さを持つか（ナッツ級、ストロング、マージナル、ドロー、ゴミ手など）を明確に判断します。
#     2.  ポットオッズとエクイティを比較し、コールが数学的に正当化されるかを評価します。
#     3.  上記の【戦略的指針】に基づき、チェックやコールといった消極的なアクションだけでなく、レイズやベットといった積極的なアクションがより高い利益をもたらさないかを検討します。
#     4.  相手のこれまでのアクションやスタックサイズを考慮し、最も期待値が高いと判断されるアクションを最終決定します。

#     【出力形式】
#     必ず次のJSON形式で回答してください。他のテキストは含めないでください。
#     {
#     "action": "fold|check|call|raise|all_in",
#     "amount": <数値（ベット/レイズの場合のみ、それ以外は0）>,
#     "reasoning": "各エージェントの分析結果と戦略的指針を踏まえ、なぜそのアクションと金額が最適だと判断したのかを詳細に説明してください。"
#     }

#     【重要な注意事項】
#     -   利用可能なアクションの範囲内でのみ決定してください。
#     -   ベット/レイズの場合は、自分や相手のスタックサイズを超えない現実的な金額を指定してください。
#     -   分析結果が矛盾する場合や情報が不完全な場合は、リスクを最小限に抑える最も安全な選択（チェックが可能ならチェック、無理ならフォールド）を検討してください。
#     """,

    # instruction="""

    # あなたは勝率計算の専門エージェントです。
    # 必ずPositionCalculatorを実行してから、EquityCalculatorを実行し、PotOddsCalculatorを実行してください。
    # この手順を守りましょう

    # 結果として以下を提供してください：
    # - hand_strength: ハンド強さ（0.0-1.0）
    # - equity: 勝率（0.0-1.0）
    # - hand_category: ハンドカテゴリ（例えば、premium、medium、low等）
    # - outs: アウツの数
    # - reasoning: 勝率計算の理由
    # - 相手の持ち点(例id:1 chips: 970,id:2 chips: 970,id:3 chips: 950.....)
    # - ポットサイズ
    # - expected_value: 期待値
    # - required_equity: 必要勝率
    # - reverse_expected_value: リバースインプライド期待値
    # - implied_multiplier: インプライド倍率
    # - pot_odds: ポットオッズ
    # - pot_odds_reasoning: ポットオッズ計算の理由
    # - action: 推奨アクション
    # """,